@use 'sass:string';

$screens: (
        sm: 640px,
        md: 768px,
        lg: 1024px,
        xl: 1280px,
        '2xl': 1536px
) !default;

$flex-directions: (
        'r': row,
        'c': column
);

$justify-map: (
        'c': center,
        's': flex-start,
        'e': flex-end,
        'b': space-between,
        'a': space-around,
        'ev': space-evenly,
        'st': stretch,
        '': null
);

$align-map: (
        'c': center,
        's': flex-start,
        'e': flex-end,
        'b': baseline,
        'st': stretch,
        '': null
);

// helpers
@function _escape-bp($bp) {
  @if $bp == '2xl' {
    @return '\\32xl';
  }
  @return $bp;
}

// emit a single base class
@mixin emit-base($class) {
  .#{$class} {
    @content;
  }
}

// emit the responsive variants for a class (sm:, md:, ...)
@mixin emit-responsive($class) {
  @each $bp, $width in $screens {
    @media (min-width: $width) {
      .#{_escape-bp($bp)}\:#{$class} {
        @content;
      }
    }
  }
}

@function _append-seg($base, $seg) {
  @if $seg == '' {
    @return $base;
  }
  $b-last: string.slice($base, -1);
  $s-first: string.slice($seg, 1, 1);
  @if $b-last == '-' and $s-first == '-' {
    @return $base + string.slice($seg, 2);
  }
  @return $base + $seg;
}

@function _trim-trailing-dash($s) {
  @if string.slice($s, -1) == '-' {
    @return string.slice($s, 1, -2);
  }
  @return $s;
}

@function _seg-justify($j) {
  @if $j == '' {
    @return '';
  }
  @if $j == 'ev' or $j == 'st' {
    @return '-' + $j + '-';
  }
  @return $j;
}

@function _seg-align($a) {
  @if $a == '' {
    @return '';
  }
  @if $a == 'st' {
    @return '-' + $a + '-';
  }
  @return $a;
}

@function _build-class($fd-key, $j-key, $a-key) {
  $name: 'f' + $fd-key;
  $name: _append-seg($name, _seg-justify($j-key));
  $name: _append-seg($name, _seg-align($a-key));
  @return _trim-trailing-dash($name);
}

//
// Phase 1: emit ALL base classes first
// This ensures base rules come before any responsive ones in the final CSS.
//
@each $fd-key, $fd-val in $flex-directions {
  @include emit-base(_build-class($fd-key, '', '')) {
    display: flex;
    flex-direction: $fd-val;
  }
}

@each $fd-key, $fd-val in $flex-directions {
  @each $j-key, $j-val in $justify-map {
    @if $j-key != '' {
      @include emit-base(_build-class($fd-key, $j-key, '')) {
        display: flex;
        flex-direction: $fd-val;
        justify-content: $j-val;
      }
      @each $a-key, $a-val in $align-map {
        @if $a-key != '' {
          @include emit-base(_build-class($fd-key, $j-key, $a-key)) {
            display: flex;
            flex-direction: $fd-val;
            justify-content: $j-val;
            align-items: $a-val;
          }
        }
      }
    }
  }
}

//
// Phase 2: emit ALL responsive variants after all base classes
// This guarantees that classes like `sm:fc` override base-only classes like `frs`
// when both apply at the same breakpoint.
//
@each $fd-key, $fd-val in $flex-directions {
  @include emit-responsive(_build-class($fd-key, '', '')) {
    display: flex;
    flex-direction: $fd-val;
  }
}

@each $fd-key, $fd-val in $flex-directions {
  @each $j-key, $j-val in $justify-map {
    @if $j-key != '' {
      @include emit-responsive(_build-class($fd-key, $j-key, '')) {
        display: flex;
        flex-direction: $fd-val;
        justify-content: $j-val;
      }
      @each $a-key, $a-val in $align-map {
        @if $a-key != '' {
          @include emit-responsive(_build-class($fd-key, $j-key, $a-key)) {
            display: flex;
            flex-direction: $fd-val;
            justify-content: $j-val;
            align-items: $a-val;
          }
        }
      }
    }
  }
}
